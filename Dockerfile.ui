# ============================================================
# ğŸ¨ Streamlit Frontend - Optimized for Lightweight Build
# ------------------------------------------------------------
# - Builder ë‹¨ê³„: ì˜ì¡´ì„± ì„¤ì¹˜
# - Runtime ë‹¨ê³„: Streamlit ì•± ì‹¤í–‰
# - CI/CD í™˜ê²½ì—ì„œ .env íŒŒì¼ì´ ì—†ì–´ë„ ì•ˆì „í•˜ê²Œ í†µê³¼
# ============================================================

# ---------- Builder Stage ----------
FROM python:3.10-slim AS builder

# ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
WORKDIR /install

# ì˜ì¡´ì„± ì„¤ì¹˜ì— í•„ìš”í•œ ìµœì†Œ íŒ¨í‚¤ì§€
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl && rm -rf /var/lib/apt/lists/*

# Streamlit ì˜ì¡´ì„± ë³µì‚¬ ë° ì„¤ì¹˜
COPY requirements_ui.txt .
RUN pip install --prefix=/install --no-cache-dir -r requirements_ui.txt


# ---------- Runtime Stage ----------
FROM python:3.10-slim

# ì•± ì‹¤í–‰ ê²½ë¡œ
WORKDIR /app

# Builderì—ì„œ ì„¤ì¹˜í•œ íŒ¨í‚¤ì§€ ë³µì‚¬
COPY --from=builder /install /usr/local

# ğŸ“‚ ì•± ê´€ë ¨ íŒŒì¼ ë³µì‚¬
COPY web ./web

# âœ… .env íŒŒì¼ì€ ì„ íƒì ìœ¼ë¡œ ì¡´ì¬ (ì—†ìœ¼ë©´ ë¬´ì‹œ)
#    - ë¡œì»¬ ì‹¤í–‰ ì‹œ: ì‹¤ì œ .env ì‚¬ìš©
#    - CI/CD í™˜ê²½: .envê°€ ì—†ì–´ë„ ë¹Œë“œ ì‹¤íŒ¨ ì—†ì´ í†µê³¼
RUN test -f .env && echo "âœ… Found .env file" || echo "âš ï¸ No .env found, skipping copy"
COPY .env ./.env || true

# Streamlit í¬íŠ¸
EXPOSE 8501

# ì‹¤í–‰ ëª…ë ¹
CMD ["streamlit", "run", "web/streamlit_app.py", "--server.port=8501", "--server.address=0.0.0.0"]
