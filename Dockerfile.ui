# ============================================================
# 🎨 Streamlit Frontend - Optimized for Lightweight Build
# ------------------------------------------------------------
# - Builder 단계: 의존성 설치
# - Runtime 단계: Streamlit 앱 실행
# - CI/CD 환경에서 .env 파일이 없어도 안전하게 통과
# ============================================================

# ---------- Builder Stage ----------
FROM python:3.10-slim AS builder

# 작업 디렉토리 생성
WORKDIR /install

# 의존성 설치에 필요한 최소 패키지
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl && rm -rf /var/lib/apt/lists/*

# Streamlit 의존성 복사 및 설치
COPY requirements_ui.txt .
RUN pip install --prefix=/install --no-cache-dir -r requirements_ui.txt


# ---------- Runtime Stage ----------
FROM python:3.10-slim

# 앱 실행 경로
WORKDIR /app

# Builder에서 설치한 패키지 복사
COPY --from=builder /install /usr/local

# 📂 앱 관련 파일 복사
COPY web ./web

# ✅ .env 파일은 선택적으로 존재 (없으면 무시)
#    - 로컬 실행 시: 실제 .env 사용
#    - CI/CD 환경: .env가 없어도 빌드 실패 없이 통과
RUN test -f .env && echo "✅ Found .env file" || echo "⚠️ No .env found, skipping copy"
COPY .env ./.env || true

# Streamlit 포트
EXPOSE 8501

# 실행 명령
CMD ["streamlit", "run", "web/streamlit_app.py", "--server.port=8501", "--server.address=0.0.0.0"]
