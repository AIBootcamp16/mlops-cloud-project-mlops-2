# =========================================================
# ğŸ–¥ï¸ Streamlit Frontend (music_recommender_ui)
# ---------------------------------------------------------
# ëª©ì :
#  - FastAPI ë°±ì—”ë“œë¡œë¶€í„° ë°ì´í„° ìˆ˜ì‹  ë° ì‹œê°í™”
#  - ë¹Œë“œ ìºì‹œ íš¨ìœ¨ & ì´ë¯¸ì§€ í¬ê¸° ìµœì†Œí™”
# =========================================================


# =========================================================
# ğŸ§± 1ï¸âƒ£ Builder Stage - Dependencies Installation
# ---------------------------------------------------------
# ë³„ë„ ë ˆì´ì–´ì—ì„œ Python íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•˜ì—¬ ìºì‹œ ì¬ì‚¬ìš© ê·¹ëŒ€í™”
# =========================================================
FROM python:3.10-slim AS builder

WORKDIR /install

# ğŸ§© í•„ìˆ˜ íŒ¨í‚¤ì§€ë§Œ ì„¤ì¹˜ (curl for healthcheck/debug)
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl && rm -rf /var/lib/apt/lists/*

# ğŸ“¦ Streamlit ì˜ì¡´ì„± ì„¤ì¹˜
COPY requirements_ui.txt .
RUN pip install --prefix=/install --no-cache-dir -r requirements_ui.txt


# =========================================================
# ğŸš€ 2ï¸âƒ£ Runtime Stage - Final Lightweight Image
# ---------------------------------------------------------
# Builderì—ì„œ ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ ë ˆì´ì–´ë§Œ ë³µì‚¬ (â‰ˆ400MB â†’ 150MBë¡œ ê°ì†Œ)
# =========================================================
FROM python:3.10-slim

# ğŸ’¼ ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ğŸ” Builderì—ì„œ ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ ë³µì‚¬
COPY --from=builder /install /usr/local

# ğŸ“‚ ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ ë³µì‚¬
COPY web ./web
COPY .env ./.env

# ğŸ§¾ í™˜ê²½ ë³€ìˆ˜
ENV PYTHONUNBUFFERED=1 \
    STREAMLIT_SERVER_PORT=8501 \
    STREAMLIT_SERVER_ADDRESS=0.0.0.0 \
    STREAMLIT_BROWSER_GATHER_USAGE_STATS=false

# ğŸ”¥ Streamlit ê¸°ë³¸ í¬íŠ¸
EXPOSE 8501

# âœ… Healthcheck (ì„ íƒ ì‚¬í•­)
HEALTHCHECK CMD curl --fail http://localhost:8501/_stcore/health || exit 1

# â–¶ï¸ Streamlit ì‹¤í–‰
CMD ["streamlit", "run", "web/streamlit_app.py", \
     "--server.port=8501", \
     "--server.address=0.0.0.0"]
