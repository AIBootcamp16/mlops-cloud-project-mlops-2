# ============================================================
# ğŸ FastAPI (Backend) Dockerfile
# ------------------------------------------------------------
# ëª©ì :
#   - FastAPI ì„œë²„ ì»¨í…Œì´ë„ˆ ë¹Œë“œ
#   - .env.safeë¥¼ í†µí•´ ë¹Œë“œ ì‹œ .env ëˆ„ë½ ì˜¤ë¥˜ ë°©ì§€
# ============================================================

# 1ï¸âƒ£ Base image
FROM python:3.11-slim AS base

# 2ï¸âƒ£ Working directory
WORKDIR /app/mlops

# 3ï¸âƒ£ System dependencies ì„¤ì¹˜
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential curl \
 && rm -rf /var/lib/apt/lists/*

# 4ï¸âƒ£ Python requirements ë³µì‚¬ ë° ì„¤ì¹˜
COPY requirements_api.txt .
RUN pip install --no-cache-dir -r requirements_api.txt

# 5ï¸âƒ£ ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY ./src ./src

# 6ï¸âƒ£ ëª¨ë¸ / ë°ì´í„° ë””ë ‰í„°ë¦¬ ìƒì„± (ì—†ì„ ê²½ìš° ëŒ€ë¹„)
RUN mkdir -p ./models ./dataset

# 7ï¸âƒ£ ëª¨ë¸ / ë°ì´í„° ë³µì‚¬ (ì—†ìœ¼ë©´ ë¬´ì‹œ)
COPY ./models ./models
COPY ./dataset ./dataset

# 8ï¸âƒ£ ì•ˆì „í•œ .env ì„¤ì • ë³µì‚¬
#     âœ… .env.safeë¥¼ .envë¡œ ë³µì‚¬í•˜ì—¬ CI í™˜ê²½ì—ì„œë„ ë¹Œë“œ ì˜¤ë¥˜ ë°©ì§€
COPY .env.safe .env

# 9ï¸âƒ£ FastAPI ì‹¤í–‰ (Uvicorn)
EXPOSE 8000
CMD ["python", "-m", "uvicorn", "src.api.api:app", "--host", "0.0.0.0", "--port", "8000"]
