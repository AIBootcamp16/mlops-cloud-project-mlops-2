# ============================================================
# 🐍 FastAPI Backend - Dockerfile (Optimized for CI/CD & GHCR)
# ------------------------------------------------------------
# - Python 3.10-slim 기반 (경량)
# - requirements.txt 캐시 최적화
# - models 폴더 제외 (런타임 로드)
# - 안전한 .env 처리 (.env.safe fallback)
# ============================================================

# 1️⃣ Build Stage
FROM python:3.10-slim AS builder

WORKDIR /app

# ------------------------------------------------------------
# 🧩 시스템 의존성 최소 설치 (빌드 캐시 최적화)
# ------------------------------------------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc build-essential libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# ------------------------------------------------------------
# 🧱 Python dependencies 캐시 최적화
# requirements.txt만 복사 후 pip install
# ------------------------------------------------------------
COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt

# ------------------------------------------------------------
# 📦 애플리케이션 코드 복사
# (src, dataset만 포함 — models는 런타임 로드)
# ------------------------------------------------------------
COPY ./src ./src
COPY ./dataset ./dataset
# COPY ./models ./models   # ❌ 제거됨 (빌드 시 필요 없음)

# ------------------------------------------------------------
# ⚙️ 환경 변수 파일 처리 (.env 또는 .env.safe)
# ------------------------------------------------------------
COPY .env.safe ./.env.safe
RUN if [ ! -f ".env" ]; then cp .env.safe .env; fi

# ------------------------------------------------------------
# 🧹 최종 이미지용 경량 세팅
# ------------------------------------------------------------
EXPOSE 8000
CMD ["uvicorn", "src.api.api:app", "--host", "0.0.0.0", "--port", "8000"]
