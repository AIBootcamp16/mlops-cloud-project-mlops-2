# ============================================================
# üéµ FastAPI Backend (music_recommender_api)
# ============================================================

FROM python:3.11-slim

WORKDIR /app/mlops

# ------------------------------------------------------------
# 1Ô∏è‚É£ System dependencies (ÎπåÎìú ÎèÑÏ§ë C/C++ ÌôïÏû• ÏÑ§ÏπòÏö©)
# ------------------------------------------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    curl \
    && rm -rf /var/lib/apt/lists/*

# ------------------------------------------------------------
# 2Ô∏è‚É£ Python dependencies
# ------------------------------------------------------------
COPY requirements_api.txt .
RUN pip install --no-cache-dir -r requirements_api.txt

# ------------------------------------------------------------
# 3Ô∏è‚É£ Application files
# ------------------------------------------------------------
COPY ./src ./src
COPY ./models ./models
COPY ./dataset ./dataset
COPY .env ./

# ------------------------------------------------------------
# 4Ô∏è‚É£ Environment variables
# ------------------------------------------------------------
ENV PYTHONUNBUFFERED=1 \
    PORT=8000 \
    HOST=0.0.0.0 \
    ENV_FILE=.env

EXPOSE 8000
HEALTHCHECK CMD curl --fail http://localhost:8000/health || exit 1

# ------------------------------------------------------------
# 5Ô∏è‚É£ Run FastAPI server
# ------------------------------------------------------------
CMD ["uvicorn", "src.api.api:app", "--host", "0.0.0.0", "--port", "8000"]
