# ============================================================
# üéß MLOps Music Recommender - FastAPI Backend (Dockerfile.api)
# ------------------------------------------------------------
# - FastAPI Í∏∞Î∞ò API ÏÑúÎ≤Ñ
# - Spotify API, MLflow, Î™®Îç∏ Î°úÎìú Îì± Ìè¨Ìï®
# - CI/CD (GitHub Actions) Î∞è Î°úÏª¨ ÌôòÍ≤Ω Î™®Îëê Ìò∏Ìôò
# ============================================================

FROM python:3.11-slim AS base

# ------------------------------------------------------------
# 1Ô∏è‚É£ ÏãúÏä§ÌÖú Í∏∞Î≥∏ ÏÑ∏ÌåÖ
# ------------------------------------------------------------
WORKDIR /app/mlops

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    curl \
    && rm -rf /var/lib/apt/lists/*

# ------------------------------------------------------------
# 2Ô∏è‚É£ Python ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
# ------------------------------------------------------------
COPY requirements_api.txt .
RUN pip install --no-cache-dir -r requirements_api.txt

# ------------------------------------------------------------
# 3Ô∏è‚É£ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò ÌååÏùº Î≥µÏÇ¨
# ------------------------------------------------------------
# src Ï†ÑÏ≤¥ Î≥µÏÇ¨
COPY ./src ./src

# ‚úÖ models Ìè¥ÎçîÍ∞Ä ÏóÜÏñ¥ÎèÑ ÎπåÎìú ÏóêÎü¨ ÏóÜÏù¥ ÌÜµÍ≥º
RUN mkdir -p ./models
COPY ./models ./models 2>/dev/null || true

# ‚úÖ dataset Ìè¥ÎçîÍ∞Ä ÏóÜÏñ¥ÎèÑ ÌÜµÍ≥º
RUN mkdir -p ./dataset
COPY ./dataset ./dataset 2>/dev/null || true

# .env ÌååÏùº (ÏóÜÏúºÎ©¥ Î¨¥Ïãú)
COPY .env ./ 2>/dev/null || true

# ------------------------------------------------------------
# 4Ô∏è‚É£ FastAPI ÏÑúÎ≤Ñ ÏÑ§Ï†ï
# ------------------------------------------------------------
EXPOSE 8000

# healthcheckÏö© Í∏∞Î≥∏ Î™ÖÎ†π (FastAPI Ïã§Ìñâ)
CMD ["uvicorn", "src.api.api:app", "--host", "0.0.0.0", "--port", "8000"]
