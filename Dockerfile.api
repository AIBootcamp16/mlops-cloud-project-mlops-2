# ============================================================
# 🚀 Dockerfile.api — FastAPI Backend for gogoAiHunters Project
# ------------------------------------------------------------
# 특징:
#   - python:3.11-slim 기반
#   - requirements_api.txt 사용
#   - models / dataset 디렉토리 없을 경우 자동 무시
# ============================================================

FROM python:3.11-slim AS base

# 환경변수 설정
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=off \
    PIP_DISABLE_PIP_VERSION_CHECK=on \
    PATH="/root/.local/bin:$PATH"

WORKDIR /app

# 2️⃣ Install dependencies
COPY requirements_api.txt .
RUN pip install --no-cache-dir -r requirements_api.txt

# 3️⃣ Copy project files
COPY . .

# 4️⃣ Ensure optional folders exist
RUN mkdir -p /app/models /app/dataset \
 && (test -d "./models" && echo "✅ models found" || echo "⚠️ no models, skipping") \
 && (test -d "./dataset" && echo "✅ dataset found" || echo "⚠️ no dataset, skipping")

# 5️⃣ Healthcheck
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
 CMD curl -f http://localhost:8000/health || exit 1

# 6️⃣ Expose & Run
EXPOSE 8000
CMD ["sh", "-c", "uvicorn src.api.api:app --host 0.0.0.0 --port 8000"]
