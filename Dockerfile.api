# ============================================================
# ğŸš€ Dockerfile.api â€” FastAPI Backend for gogoAiHunters Project
# ------------------------------------------------------------
# íŠ¹ì§•:
#   - python:3.11-slim ê¸°ë°˜
#   - models / dataset ë””ë ‰í† ë¦¬ ì—†ì„ ê²½ìš° ìë™ ë¬´ì‹œ
#   - .env, requirements.txt í¬í•¨
# ============================================================

# 1ï¸âƒ£ Base Stage ------------------------------------------------
FROM python:3.11-slim AS base

# í™˜ê²½ë³€ìˆ˜ ì„¤ì •
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=off \
    PIP_DISABLE_PIP_VERSION_CHECK=on \
    PATH="/root/.local/bin:$PATH"

# ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
WORKDIR /app

# 2ï¸âƒ£ Install Dependencies --------------------------------------
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 3ï¸âƒ£ Copy Project Files ----------------------------------------
COPY . .

# 4ï¸âƒ£ Ensure optional folders exist ------------------------------
# models / dataset í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ë¹ˆ ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p /app/models /app/dataset \
 && (test -d "./models" && echo "âœ… models found" || echo "âš ï¸ no models, skipping") \
 && (test -d "./dataset" && echo "âœ… dataset found" || echo "âš ï¸ no dataset, skipping")

# 5ï¸âƒ£ Healthcheck script ----------------------------------------
# FastAPI ì„œë²„ì˜ /health ì—”ë“œí¬ì¸íŠ¸ë¡œ ìƒíƒœ í™•ì¸
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
 CMD curl -f http://localhost:8000/health || exit 1

# 6ï¸âƒ£ Expose FastAPI Port ---------------------------------------
EXPOSE 8000

# 7ï¸âƒ£ Run Command -----------------------------------------------
# .env íŒŒì¼ì´ ìˆìœ¼ë©´ ìë™ ë¡œë“œ (python-dotenv ì‚¬ìš©)
CMD ["sh", "-c", "uvicorn src.api.api:app --host 0.0.0.0 --port 8000"]
