# ============================================================
# ğŸ FastAPI Backend - Dockerfile (Optimized for CI/CD & GHCR)
# ------------------------------------------------------------
# - Python 3.10-slim ê¸°ë°˜ (ê²½ëŸ‰)
# - requirements.txt ìºì‹œ ìµœì í™”
# - models í´ë” ì œì™¸ (ëŸ°íƒ€ì„ ë¡œë“œ)
# - ì•ˆì „í•œ .env ì²˜ë¦¬ (.env.safe fallback)
# ============================================================

# 1ï¸âƒ£ Build Stage
FROM python:3.10-slim AS builder

WORKDIR /app

# ------------------------------------------------------------
# ğŸ§© ì‹œìŠ¤í…œ ì˜ì¡´ì„± ìµœì†Œ ì„¤ì¹˜ (ë¹Œë“œ ìºì‹œ ìµœì í™”)
# ------------------------------------------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc build-essential libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# ------------------------------------------------------------
# ğŸ§± Python dependencies ìºì‹œ ìµœì í™”
# requirements.txtë§Œ ë³µì‚¬ í›„ pip install
# ------------------------------------------------------------
COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt

# ------------------------------------------------------------
# ğŸ“¦ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
# (src, datasetë§Œ í¬í•¨ â€” modelsëŠ” ëŸ°íƒ€ì„ ë¡œë“œ)
# ------------------------------------------------------------
COPY ./src ./src
COPY ./dataset ./dataset
# COPY ./models ./models   # âŒ ì œê±°ë¨ (ë¹Œë“œ ì‹œ í•„ìš” ì—†ìŒ)

# ------------------------------------------------------------
# âš™ï¸ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ì²˜ë¦¬ (.env ë˜ëŠ” .env.safe)
# ------------------------------------------------------------
COPY .env.safe ./.env.safe
RUN if [ ! -f ".env" ]; then cp .env.safe .env; fi

# ------------------------------------------------------------
# ğŸ§¹ ìµœì¢… ì´ë¯¸ì§€ìš© ê²½ëŸ‰ ì„¸íŒ…
# ------------------------------------------------------------
EXPOSE 8000
CMD ["uvicorn", "src.api.api:app", "--host", "0.0.0.0", "--port", "8000"]
