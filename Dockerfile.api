# ============================================================
# ğŸ§ MLOps Music Recommender - FastAPI Backend (Dockerfile.api)
# ------------------------------------------------------------
# - FastAPI ê¸°ë°˜ API ì„œë²„
# - Spotify API, MLflow, ëª¨ë¸ ë¡œë“œ í¬í•¨
# - CI/CD (GitHub Actions) ë° ë¡œì»¬ í™˜ê²½ ëª¨ë‘ í˜¸í™˜
# ============================================================

FROM python:3.11-slim AS base

# ------------------------------------------------------------
# 1ï¸âƒ£ ì‹œìŠ¤í…œ ê¸°ë³¸ ì„¸íŒ…
# ------------------------------------------------------------
WORKDIR /app/mlops

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    curl \
    && rm -rf /var/lib/apt/lists/*

# ------------------------------------------------------------
# 2ï¸âƒ£ Python ì˜ì¡´ì„± ì„¤ì¹˜
# ------------------------------------------------------------
COPY requirements_api.txt .
RUN pip install --no-cache-dir -r requirements_api.txt

# ------------------------------------------------------------
# 3ï¸âƒ£ ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ ë³µì‚¬
# ------------------------------------------------------------
COPY ./src ./src

# âœ… models í´ë”ê°€ ìˆì„ ë•Œë§Œ ë³µì‚¬
RUN mkdir -p ./models
RUN [ -d "./models" ] && cp -r ./models ./models || echo "âš ï¸ no models folder found, skipping"

# âœ… dataset í´ë”ê°€ ìˆì„ ë•Œë§Œ ë³µì‚¬
RUN mkdir -p ./dataset
RUN [ -d "./dataset" ] && cp -r ./dataset ./dataset || echo "âš ï¸ no dataset folder found, skipping"

# âœ… .env íŒŒì¼ì´ ìˆì„ ë•Œë§Œ ë³µì‚¬
RUN [ -f ".env" ] && cp .env ./ || echo "âš ï¸ no .env file found, skipping"

# ------------------------------------------------------------
# 4ï¸âƒ£ FastAPI ì„œë²„ ì„¤ì •
# ------------------------------------------------------------
EXPOSE 8000

CMD ["uvicorn", "src.api.api:app", "--host", "0.0.0.0", "--port", "8000"]
