version: "3.9"

services:
  # mlops-dev:
  #   build: .
  #   container_name: train_test
  #   env_file:
  #     - .env
  #   volumes:
  #     - ./mlops-cloud-project-mlops-2:/app/mlops  # 로컬 코드 공유
  #   working_dir: /app/mlops/src
  #   tty: true
  #   command: bash

  airflow:
    build: .
    container_name: airflow
    env_file:
      - .env
    ports:
      - "8080:8080"           # Airflow 웹서버 포트
    volumes:
      - ./dags:/usr/local/airflow/dags    # DAG 코드 동기화
      - ./logs:/usr/local/airflow/logs    # 로그 저장
      - ./src:/app/src                    # 학습/전처리 코드
    environment:
      - AIRFLOW_HOME=/usr/local/airflow
      - EC2_HOST=${EC2_HOST}
      - EC2_USER=${EC2_SSH_KEY}
    working_dir: /usr/local/airflow
    # command: bash -c "airflow db init && airflow webserver -p 8080 & airflow scheduler"    
    command: >
      bash -c "
      airflow db init &&
      airflow users create --username airflow --password airflow --firstname air --lastname flow --role Admin --email airflow@example.com &&
      airflow webserver -p 8080 &
      airflow scheduler
      "
