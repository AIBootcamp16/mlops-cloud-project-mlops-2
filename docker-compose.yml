# ============================================================
# 🧩 MLOps Project - Local Docker Compose
# ------------------------------------------------------------
# 목적:
#   - 로컬에서 FastAPI + Streamlit UI 통합 실행
#   - CI/CD 빌드 구조와 동일한 이미지 구조 유지
# ============================================================

version: "3.9"

services:
  # ----------------------------------------------------------
  # 🐍 FastAPI Backend
  # ----------------------------------------------------------
  api_service:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: music_recommender_api
    ports:
      - "8000:8000"
    env_file:
      - .env.safe
    volumes:
      - ./src:/app/src
      - ./dataset:/app/dataset
      - ./models:/app/models   # ✅ 루트 models 폴더 마운트
    command: uvicorn src.api.api:app --host 0.0.0.0 --port 8000

  # ----------------------------------------------------------
  # 🎨 Streamlit UI
  # ----------------------------------------------------------
  ui_service:
    build:
      context: .
      dockerfile: Dockerfile.ui
    container_name: music_recommender_ui
    ports:
      - "8501:8501"
    depends_on:
      - api_service
    env_file:
      - .env.safe
    volumes:
      - ./web:/app/web
      - ./dataset:/app/dataset
    command: streamlit run web/streamlit_app.py --server.port=8501 --server.address=0.0.0.0

  # ----------------------------------------------------------
  # 📊 MLflow Tracking (optional)
  # ----------------------------------------------------------
  mlops_runner:
    build:
      context: .
      dockerfile: Dockerfile.mlflow
    container_name: mlops_runner
    ports:
      - "5000:5000"
    environment:
      - MLFLOW_TRACKING_URI=http://0.0.0.0:5000
      - BACKEND_STORE_URI=sqlite:///mlflow.db
    volumes:
      - ./mlruns:/app/mlruns

# ============================================================
# 🔹 실행 방법
# ------------------------------------------------------------
# ▶ docker compose up --build
# ▶ Streamlit: http://localhost:8501
# ▶ FastAPI:   http://localhost:8000
# ▶ MLflow:    http://localhost:5000
# ============================================================
