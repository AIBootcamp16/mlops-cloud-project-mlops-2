version: "3.9"

services:
  mlops_airflow:
    build:
      context: .
      dockerfile: Dockerfile.airflow
    container_name: mlops_airflow
    ports:
      - "8080:8080" # Airflow ì›¹ UI
    volumes:
      - ./dags:/usr/local/airflow/dags
      - ./tmp:/tmp
    environment:
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
    command: >
      bash -c "
      airflow db init &&
      airflow users create --username admin --firstname Admin --lastname User --role Admin --email admin@example.com --password admin123 &&
      airflow webserver & airflow scheduler
      "

  mlops_runner:
    build:
      context: .
      dockerfile: Dockerfile.mlflow
    container_name: mlops_runner
    env_file:
      - .env
    volumes:
       - .:/app/mlops
    working_dir: /app/mlops/src
    tty: true
    command: bash

  # ----------------------------------------------------
  # [ìƒˆë¡œ ì¶”ê°€ëœ ì„œë¹„ìŠ¤ 1: FastAPI ë°±ì—”ë“œ API]
  # ----------------------------------------------------
  api_service:
    build: 
      context: .
      # 1ë‹¨ê³„ì—ì„œ ìƒì„±í•œ FastAPIìš© Dockerfileì„ ì§€ì •í•©ë‹ˆë‹¤.
      dockerfile: Dockerfile.api
    container_name: music_recommender_api
    ports:
      # ë¡œì»¬ í¬íŠ¸ 8000ê³¼ ì»¨í…Œì´ë„ˆ í¬íŠ¸ 8000 ì—°ê²°
      - "8000:8000"
    volumes:
      # ëª¨ë¸ ë° ë°ì´í„° ì ‘ê·¼ì„ ìœ„í•œ ë³¼ë¥¨ ë§ˆìš´íŠ¸ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      # (ì‚¬ìš©ìë‹˜ì˜ í”„ë¡œì íŠ¸ êµ¬ì¡°ì— ë§ê²Œ ìˆ˜ì •í•´ì£¼ì„¸ìš”)
      - .:/app/mlops  # ë¡œì»¬ í”„ë¡œì íŠ¸ ë£¨íŠ¸(.)ë¥¼ ì»¨í…Œì´ë„ˆ /app/mlopsì— ë§ˆìš´íŠ¸
      # - ./dataset/processed:/app/dataset/processed  <-- datasets í´ë”ëŠ” /app/mlops/datasetì— í¬í•¨ë˜ë¯€ë¡œ ì œê±° ê°€ëŠ¥
    env_file:
      - .env
    environment:
      # Streamlitì´ í˜¸ì¶œí•  API ì£¼ì†Œë¥¼ ë‚´ë¶€ ë„ì»¤ ë„¤íŠ¸ì›Œí¬ ì´ë¦„ìœ¼ë¡œ ì„¤ì •
      API_BASE: http://api_service:8000 
    command: >
      uvicorn src.api.api:app --host 0.0.0.0 --port 8000
    # APIê°€ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í—¬ìŠ¤ ì²´í¬ ì„¤ì • (Streamlit ì‹œì‘ ì „ ëŒ€ê¸°ìš©)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s

  # ----------------------------------------------------
  # [ìƒˆë¡œ ì¶”ê°€ëœ ì„œë¹„ìŠ¤ 2: Streamlit í”„ë¡ íŠ¸ì—”ë“œ UI]
  # ----------------------------------------------------
  streamlit_ui:
    build:
      context: .
      # Streamlitìš© Dockerfileì„ ì§€ì •í•©ë‹ˆë‹¤.
      dockerfile: Dockerfile.streamlit 
    container_name: music_recommender_ui
    ports:
      # ë¡œì»¬ í¬íŠ¸ 8501ê³¼ Streamlit ê¸°ë³¸ í¬íŠ¸ ì—°ê²°
      - "8501:8501"
    volumes:
      # Streamlit ì•± ì‹¤í–‰ì— í•„ìš”í•œ ì½”ë“œ í´ë”ë¥¼ ë§ˆìš´íŠ¸í•©ë‹ˆë‹¤.
      - .:/app
      # ğŸ’¡ secrets.toml ë§ˆìš´íŠ¸ ğŸ’¡
      - ./.streamlit:/app/.streamlit
    env_file:
      - .env
    environment:
      # Streamlit ì•±ì´ ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ì˜ APIë¥¼ í˜¸ì¶œí•˜ë„ë¡ ì£¼ì†Œ ì„¤ì •
      API_BASE: http://api_service:8000 
    # API ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ëœ í›„ì— Streamlitì„ ì‹œì‘í•˜ë„ë¡ ì„¤ì •
    #depends_on:
    #  api_service:
    #    condition: service_healthy