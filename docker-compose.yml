# ============================================================
# ğŸ§© MLOps Project - Local Docker Compose
# ------------------------------------------------------------
# ëª©ì :
#   - ë¡œì»¬ì—ì„œ FastAPI + Streamlit UI í†µí•© ì‹¤í–‰
#   - CI/CD ë¹Œë“œ êµ¬ì¡°ì™€ ë™ì¼í•œ ì´ë¯¸ì§€ êµ¬ì¡° ìœ ì§€
# ============================================================

version: "3.9"

services:
  # ----------------------------------------------------------
  # ğŸ FastAPI Backend
  # ----------------------------------------------------------
  api_service:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: music_recommender_api
    ports:
      - "8000:8000"
    env_file:
      - .env.safe
    volumes:
      - ./src:/app/src
      - ./dataset:/app/dataset
      - ./models:/app/models   # âœ… ë£¨íŠ¸ models í´ë” ë§ˆìš´íŠ¸
    command: uvicorn src.api.api:app --host 0.0.0.0 --port 8000

  # ----------------------------------------------------------
  # ğŸ¨ Streamlit UI
  # ----------------------------------------------------------
  ui_service:
    build:
      context: .
      dockerfile: Dockerfile.ui
    container_name: music_recommender_ui
    ports:
      - "8501:8501"
    depends_on:
      - api_service
    env_file:
      - .env.safe
    volumes:
      - ./web:/app/web
      - ./dataset:/app/dataset
    command: streamlit run web/streamlit_app.py --server.port=8501 --server.address=0.0.0.0

  # ----------------------------------------------------------
  # ğŸ“Š MLflow Tracking (optional)
  # ----------------------------------------------------------
  mlops_runner:
    build:
      context: .
      dockerfile: Dockerfile.mlflow
    container_name: mlops_runner
    ports:
      - "5000:5000"
    environment:
      - MLFLOW_TRACKING_URI=http://0.0.0.0:5000
      - BACKEND_STORE_URI=sqlite:///mlflow.db
    volumes:
      - ./mlruns:/app/mlruns

# ============================================================
# ğŸ”¹ ì‹¤í–‰ ë°©ë²•
# ------------------------------------------------------------
# â–¶ docker compose up --build
# â–¶ Streamlit: http://localhost:8501
# â–¶ FastAPI:   http://localhost:8000
# â–¶ MLflow:    http://localhost:5000
# ============================================================
