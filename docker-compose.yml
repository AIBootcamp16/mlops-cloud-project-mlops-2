# ============================================================
# ğŸ§  MLOps Music Recommendation System â€” Stable Release
# ------------------------------------------------------------
# êµ¬ì„± ìš”ì†Œ:
#   ğŸµ music_recommender_api  : FastAPI ë°±ì—”ë“œ (ì¶”ì²œ ì„œë²„)
#   ğŸ–¥ï¸ music_recommender_ui   : Streamlit í”„ë¡ íŠ¸ì—”ë“œ
#   ğŸ§© mlops_airflow_web/scheduler : Airflow ê´€ë¦¬ UI + ìŠ¤ì¼€ì¤„ëŸ¬
#   âš™ï¸ mlops_runner           : MLflow / í•™ìŠµ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ê¸°
# ------------------------------------------------------------
# ëª¨ë“  ì»¨í…Œì´ë„ˆëŠ” ë™ì¼í•œ ë„¤íŠ¸ì›Œí¬(mlops_network)ë¥¼ ê³µìœ í•©ë‹ˆë‹¤.
# ============================================================

version: "3.9"

services:
  # ----------------------------------------------------------
  # ğŸµ FastAPI â€” ìŒì•… ì¶”ì²œ API ì„œë²„
  # ----------------------------------------------------------
  music_recommender_api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: music_recommender_api
    ports:
      - "8000:8000"
    env_file:
      - .env
    volumes:
      - ./src:/app/src
      - ./models:/app/models
      - ./dataset/processed:/app/dataset/processed
    networks:
      - mlops_network
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ----------------------------------------------------------
  # ğŸ–¥ï¸ Streamlit â€” UI í”„ë¡ íŠ¸ì—”ë“œ
  # ----------------------------------------------------------
  music_recommender_ui:
    build:
      context: .
      dockerfile: Dockerfile.ui
    container_name: music_recommender_ui
    ports:
      - "8501:8501"
    env_file:
      - .env
    depends_on:
      - music_recommender_api
    volumes:
      - ./src/web:/app/web
    networks:
      - mlops_network
    restart: always

  # ----------------------------------------------------------
  # ğŸ§± Airflow â€” ì›¹ UI + ìŠ¤ì¼€ì¤„ëŸ¬
  # ----------------------------------------------------------
  mlops_airflow_web:
    build:
      context: .
      dockerfile: Dockerfile.airflow
    container_name: mlops_airflow_web
    command: webserver
    ports:
      - "8080:8080"
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__CORE__SQL_ALCHEMY_CONN=sqlite:////usr/local/airflow/airflow.db
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
    volumes:
      - ./dags:/usr/local/airflow/dags
      - ./logs:/usr/local/airflow/logs
    networks:
      - mlops_network
    restart: always

  mlops_airflow_scheduler:
    build:
      context: .
      dockerfile: Dockerfile.airflow
    container_name: mlops_airflow_scheduler
    command: scheduler
    depends_on:
      - mlops_airflow_web
    volumes:
      - ./dags:/usr/local/airflow/dags
      - ./logs:/usr/local/airflow/logs
    networks:
      - mlops_network
    restart: always

  # ----------------------------------------------------------
  # âš™ï¸ Runner â€” MLflow / í•™ìŠµ íŒŒì´í”„ë¼ì¸ (ë°ì´í„° ì¬ìƒì„± ì—†ìŒ)
  # ----------------------------------------------------------
  mlops_runner:
    build:
      context: .
      dockerfile: Dockerfile.mlflow
    container_name: mlops_runner
    env_file:
      - .env
    volumes:
      - ./src:/app/src
      - ./models:/app/models
      - ./dataset:/app/dataset
    networks:
      - mlops_network
    tty: true
    restart: on-failure
    # âŒ ìë™ ë°ì´í„° ì¬ìƒì„± ì œê±° (build_dataset.py ì‹¤í–‰ ì—†ìŒ)
    # í•„ìš”ì‹œ ìˆ˜ë™ ì‹¤í–‰:
    # docker exec -it mlops_runner python src/data/build_dataset.py

# ------------------------------------------------------------
# ğŸŒ ê³µí†µ ë„¤íŠ¸ì›Œí¬
# ------------------------------------------------------------
networks:
  mlops_network:
    driver: bridge
