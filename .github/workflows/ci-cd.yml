name: CI/CD Pipeline

on:
  # pull_request:
  #   branches: [ "main" ]   # PR ìƒì„± ì‹œ ì½”ë“œ í…ŒìŠ¤íŠ¸ (CI)
  pull_request_target:
    branches: [ "main" ]
  push:
    branches: [ "main" ]   # main ë¸Œëœì¹˜ì— merge í›„ CD ì‹¤í–‰

jobs:
  # -------------------------------
  # CI: Pull Request ì‹œ ì½”ë“œ ê²€ì¦, slack
  # -------------------------------
  ci-test:
    runs-on: ubuntu-latest
    # if: github.event_name == 'pull_request' && github.repository == 'AIBootcamp16/mlops-cloud-project-mlops-2'
    if: github.event_name == 'pull_request_target'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies (skip if unchanged)
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -qE 'requirements.txt'; then
            pip install -r requirements.txt
          else
            echo "requirements.txt unchanged, skipping install"
          fi

      - name: Run lint and basic tests
        run: |
          echo "âœ… Running code validation..."
          python -m compileall .
          echo "âœ… Code syntax check passed."

      - name: Send Slack notification (safe for fork PRs)
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": ":sparkles: *ìƒˆë¡œìš´ Pull Requestê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!*"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Repository:*\n${{ github.repository }}" },
                    { "type": "mrkdwn", "text": "*ì‘ì„±ì:*\n${{ github.actor }}" },
                    { "type": "mrkdwn", "text": "*ì œëª©:*\n${{ github.event.pull_request.title }}" },
                    { "type": "mrkdwn", "text": "*ë‚´ìš©:*\n${{ github.event.pull_request.body || 'No description provided.' }}" },
                    { "type": "mrkdwn", "text": "*ìƒì„± ì‹œê°:*\n${{ github.event.pull_request.created_at }}" }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": { "type": "plain_text", "text": "ğŸ”— Pull Request ë³´ëŸ¬ê°€ê¸°" },
                      "url": "${{ github.event.pull_request.html_url }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # -------------------------------
  # CD: Merge í›„ EC2ì— ë°°í¬, slack
  # -------------------------------
  cd-deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.repository == 'AIBootcamp16/mlops-cloud-project-mlops-2'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Decide if rebuild is needed
        id: rebuild
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -qE 'Dockerfile|requirements.txt'; then
            echo "REBUILD=true" >> $GITHUB_ENV
          else
            echo "REBUILD=false" >> $GITHUB_ENV
          fi

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and push Docker image (if needed)
        if: env.REBUILD == 'true'
        run: |
          IMAGE_TAG="becky77/mlops:${GITHUB_SHA::8}"
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          docker build -t $IMAGE_TAG .
          docker push $IMAGE_TAG

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/mlops-cloud-project-mlops-2
            echo "ğŸ”„ Pulling latest code from main branch..."
            git fetch origin main
            git pull origin main
            if [ "${REBUILD}" == "true" ]; then
              docker pull $IMAGE_TAG
              docker compose down
              docker compose up -d --build
            else
              docker compose restart airflow
            fi
            echo "âœ… Deployment complete on EC2"

      - name: Notify Slack - Deployment Complete
        if: always()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸš€ ë°°í¬ ì™„ë£Œ ì•Œë¦¼"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "* Repository:*\n${{ github.repository }}" },
                    { "type": "mrkdwn", "text": "* ë°°í¬ ë¸Œëœì¹˜:*\n${{ github.ref_name }}" },
                    { "type": "mrkdwn", "text": "* ë³‘í•©ëœ PR ë©”ì‹œì§€:*\n${{ github.event.head_commit.message }}" },
                    { "type": "mrkdwn", "text": "* ë³‘í•©ì:*\n${{ github.actor }}" },
                    { "type": "mrkdwn", "text": "* ë°°í¬ ì‹œê°:*\n${{ github.event.head_commit.timestamp }}" },
                    { "type": "mrkdwn", "text": "* ì»¤ë°‹:*\n${{ github.sha }}" },
                    { "type": "mrkdwn", "text": "* ë°°í¬ ëŒ€ìƒ:*\nEC2 - ${{ secrets.EC2_HOST }}" }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": { "type": "plain_text", "text": "ğŸ”— ì»¤ë°‹ ë³´ëŸ¬ê°€ê¸°" },
                      "url": "https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}